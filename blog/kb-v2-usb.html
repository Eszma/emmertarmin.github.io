<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Keyboard PCB with USB hub | Armin Emmert</title>
    <meta name="description" content="">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon.png">
  <link rel="icon" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.e7b5faba.css" as="style"><link rel="preload" href="/assets/js/app.36256a3f.js" as="script"><link rel="preload" href="/assets/js/4.0f127261.js" as="script"><link rel="preload" href="/assets/js/6.1357b318.js" as="script"><link rel="preload" href="/assets/js/18.f16249e7.js" as="script"><link rel="prefetch" href="/assets/js/10.1bcc4d4a.js"><link rel="prefetch" href="/assets/js/11.8d9c65af.js"><link rel="prefetch" href="/assets/js/12.6548ec23.js"><link rel="prefetch" href="/assets/js/13.d773a14c.js"><link rel="prefetch" href="/assets/js/14.6d2d8b61.js"><link rel="prefetch" href="/assets/js/15.ab5df486.js"><link rel="prefetch" href="/assets/js/16.eadf2876.js"><link rel="prefetch" href="/assets/js/17.cf614be6.js"><link rel="prefetch" href="/assets/js/19.22bd9cf2.js"><link rel="prefetch" href="/assets/js/20.a24e28fe.js"><link rel="prefetch" href="/assets/js/21.177eafb7.js"><link rel="prefetch" href="/assets/js/22.305e8955.js"><link rel="prefetch" href="/assets/js/3.471dadce.js"><link rel="prefetch" href="/assets/js/5.0d9d02ef.js"><link rel="prefetch" href="/assets/js/7.99b6ba80.js"><link rel="prefetch" href="/assets/js/8.3059b046.js"><link rel="prefetch" href="/assets/js/9.0945ce03.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.242eb1d2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e7b5faba.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/vuepress-blog-logo.png" alt="Armin Emmert" class="logo"> <span class="site-name can-hide">Armin Emmert</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/archive/" class="nav-link">Archive</a></div><div class="nav-item"><a href="/rss.xml" class="nav-link">
  RSS Feed
</a></div> <a href="https://github.com/emmertarmin/emmertarmin.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    Repo
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <div class="nav-item"><label class="switch"><input type="checkbox" id="darkmode" name="darkmode"> <span class="slider"></span></label></div></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/archive/" class="nav-link">Archive</a></div><div class="nav-item"><a href="/rss.xml" class="nav-link">
  RSS Feed
</a></div> <a href="https://github.com/emmertarmin/emmertarmin.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    Repo
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <div class="nav-item"><label class="switch"><input type="checkbox" id="darkmode" name="darkmode"> <span class="slider"></span></label></div></nav>  <!----> </div> <div class="blog" data-v-5ebcfcbc><div class="blog__header" data-v-5ebcfcbc><p class="publish-date" data-v-5ebcfcbc><time datetime="2020-06-20T00:00:00.000Z" data-v-5ebcfcbc>2020-06-20</time></p> <p data-v-5ebcfcbc>Time to read: 8 min read</p> <h1 class="blog__title" data-v-5ebcfcbc>Keyboard PCB with USB hub</h1></div> <div class="custom content default" data-v-5ebcfcbc><p></p><div class="table-of-contents"><ul><li><a href="#qmk">QMK</a></li><li><a href="#schematic">Schematic</a></li><li><a href="#routing">Routing</a></li><li><a href="#don-t-use-stm32f103">Don't use STM32F103</a></li><li><a href="#safety-first">Safety first</a></li><li><a href="#iso-enter-confusion">ISO Enter confusion</a></li><li><a href="#conclusion-of-v1">Conclusion of V1</a></li><li><a href="#usb-hub">USB hub</a></li><li><a href="#back-side-of-the-pcb">Back side of the PCB</a></li><li><a href="#plate">Plate</a></li></ul></div><p></p> <h1 id="main-resources"><a href="#main-resources" aria-hidden="true" class="header-anchor">#</a> Main Resources</h1> <h2 id="qmk"><a href="#qmk" aria-hidden="true" class="header-anchor">#</a> QMK</h2> <p>I was lurking r/mk for half a year probably, and it never occurred to me that I could build my own custom keyboard, until I learned about <a href="https://qmk.fm/">QMK</a>. QMK is an open source firmware for keyboards. It supports a bunch of different hardware, including some STM processors. It has an excessive (though not all-encompassing) documentation helping newcomers, and supports backlighting, tap-dance and other awesome features that you won't get with a home-brew Arduino program.</p> <h2 id="schematic"><a href="#schematic" aria-hidden="true" class="header-anchor">#</a> Schematic</h2> <p>There's not incredibly many open source keyboards, but there's quite a few. Gondolindrim made the best ones, in my opinion, the Keyboards in the <a href="http://acheronproject.com/overview.html">Acheron Project</a>. In the QMK Discord he himself recommends newbs to take notice of the <a href="https://github.com/AcheronProject/Tsuki">Tsuki</a>, which has all the features and best practices. I've learnt quite a few things from studying his schematics. The Schottky-diode above the LDO that protects it from backwards current, for example, is an overengineered detail, that I appreciate, when I discover it.</p> <h2 id="routing"><a href="#routing" aria-hidden="true" class="header-anchor">#</a> Routing</h2> <p>I found this <a href="https://wiki.ai03.me/books/pcb-design/page/good-usb-routing-practices">great resource</a> about USB-C routing practices. USB-C in itself is relatively complicated, but by pulling down the CC lines with 5.1k resistors it gets converted to a standard 5 pin USB, which then is easier to handle.</p> <p><img src="/img/kb_v2_usb/usb-c.png" alt="USB-C Schematic"></p> <h1 id="first-prototype"><a href="#first-prototype" aria-hidden="true" class="header-anchor">#</a> First prototype</h1> <p>I spent quite some time working on my first PCB, and I knew I wouldn't get everything right, but mostly I hoped to clear up a lot of things I wasn't sure about, and that I could get it work in some way or another.</p> <h2 id="don-t-use-stm32f103"><a href="#don-t-use-stm32f103" aria-hidden="true" class="header-anchor">#</a> Don't use STM32F103</h2> <p>I went with an STM32F103R8C6 chip because I was familiar with it, and because it's what <a href="https://stm32-base.org/boards/STM32F103C8T6-Blue-Pill.html">Bluepill</a> uses, and QMK proclaims to be compatible with it. In hindsight it was a bad choice. The F103 doesn't have a USB bootloader from factory, like the F303, F072, and others do. I did flash some sort of a <a href="https://github.com/rogerclarkmelbourne/STM32duino-bootloader">maple bootloader</a> on it with an ST-Link, but I never really managed to get QMK to work on it. Fortunately I my design also had a led on PA13, which confirmed that the bootloader flashed fine. But flashing QMK resulted in this weird &quot;97% completion&quot; error every time, which according to Cannonkeys can be <a href="https://docs.cannonkeys.com/flashing/">safely ignored</a> (?), and my computer just wouldn't recognize it as a HID device.</p> <p><img src="/img/kb_v2_usb/cannonkeys_error.png" alt="Error message"></p> <p>After about two days of this, I placed an order of STM32L072 chips, which do come with a USB bootloader. The L072 has the 22Ohm series resistors and the 1.5k pullup on D+ line built in, and it is also capable of crystalless USB operation. Of all the SMD components, I hate soldering crystals the most, so I really hope I interpreted that feature right.</p> <h2 id="safety-first"><a href="#safety-first" aria-hidden="true" class="header-anchor">#</a> Safety first</h2> <p>By the way, I didn't just plug the board into the computer without much thought. I actually broke out GND, +3V3, and +5V, so that I could easily test for short circuits. And when I was confident, I first connected it to 5V from a power supply to check for magic smoke. Then I measured the voltages, and actually discovered a diode this way, which was soldered on backwards. Only when everything checked out, did I connect it to my laptop.</p> <h2 id="iso-enter-confusion"><a href="#iso-enter-confusion" aria-hidden="true" class="header-anchor">#</a> ISO Enter confusion</h2> <p>The ISO Enter key doesn't have good documentation, or at least I didn't find any. I inferred the switch placement under it via the <a href="http://builder.swillkb.com/">swillkb</a> plate builder.</p> <p><img src="/img/kb_v2_usb/iso_enter.svg" alt="ISO Enter switch placement"></p> <div class="tip custom-block"><p class="custom-block-title">ISO Enter switch placement</p> <p>Vertically, it's in the middle of the 2U height of the Enter key, and horizontally it's in the middle of the narrower, 1.25U wide bottom part of the key.</p></div> <p>But only when my Tai Hao keycaps arrived, did I learn that the cherry switch underneath has to be upright. Basically, taking a 2U stabilizer together with the switch footprint (e.g. the whole BackSpace key), and rotating it 90 degrees won't work. The stabilizer does have to be rotated to be in a vertical position, but the switch doesn't. The cross profile pin on top of the switch is thicker in one orientation, and thinner in the other, so it only fits the keycap in two of four directions, if that makes sense. To illustrate:</p> <p><img src="/img/kb_v2_usb/iso_enter_footprint.png" alt="ISO Enter switch placement"></p> <h2 id="conclusion-of-v1"><a href="#conclusion-of-v1" aria-hidden="true" class="header-anchor">#</a> Conclusion of V1</h2> <p>First of all I've learnt a lot about the correctness and fails.</p> <h1 id="layout-and-features-of-v2"><a href="#layout-and-features-of-v2" aria-hidden="true" class="header-anchor">#</a> Layout and Features of V2</h1> <p>I've ordered V1 already, which cleared up many things, but didn't include all the features, and had many issues. I have great hopes for V2, which I'm still about to order, but I'm happy enough with it that I want to discuss it beforehand.</p> <p><img src="/img/kb_v2_usb/top.svg" alt="PCB top"></p> <p>The image above of the top of the PCB was created with <a href="https://tracespace.io">tracespace.io</a>, which is open source, and generates awesome looking svg images. You just need to upload the same gerber files that you would send to the PCB manufacturer.</p> <p>I decided to branch off of &quot;the 75%&quot; layout, which means it is tenkeyless, has the whole function row, and has the arrows compressed under &quot;Enter&quot;. The top right corner supports a regular switch or an encoder. You can inspect it on <a href="http://www.keyboard-layout-editor.com/##@_name=75%25%3B&amp;@=Esc&amp;=F1&amp;=F2&amp;=F3&amp;=F4&amp;=F5&amp;=F6&amp;=F7&amp;=F8&amp;=F9&amp;=F10&amp;=F11&amp;=F12&amp;=PgUp&amp;=PgDn&amp;=ENC%3B&amp;@=~`&amp;=!1&amp;=%2F@2&amp;=%233&amp;=$4&amp;=%255&amp;=^6&amp;=%2F&amp;7&amp;=*8&amp;=(9&amp;=)0&amp;=%2F_-&amp;=+%2F=&amp;_w:2%3B&amp;=Backspace&amp;=Delete%3B&amp;@_w:1.5%3B&amp;=Tab&amp;=Q&amp;=W&amp;=E&amp;=R&amp;=T&amp;=Y&amp;=U&amp;=I&amp;=O&amp;=P&amp;={[&amp;=}]&amp;_x:0.25&amp;w:1.25&amp;h:2&amp;w2:1.5&amp;h2:1&amp;x2:-0.25%3B&amp;=Enter&amp;_a:7%3B&amp;=%3B&amp;@_a:4&amp;w:1.75%3B&amp;=Caps Lock&amp;=A&amp;=S&amp;=D&amp;=F&amp;=G&amp;=H&amp;=J&amp;=K&amp;=L&amp;=%2F:%2F%3B&amp;=%22'&amp;=|\&amp;_x:1.25%3B&amp;=Home%3B&amp;@_w:1.25%3B&amp;=Shift&amp;=|\&amp;=Z&amp;=X&amp;=C&amp;=V&amp;=B&amp;=N&amp;=M&amp;=&lt;,&amp;=&gt;.&amp;=%3F%2F%2F&amp;_w:1.75%3B&amp;=Shift&amp;=↑&amp;=End%3B&amp;@_w:1.25%3B&amp;=Ctrl&amp;_w:1.25%3B&amp;=Win&amp;_w:1.25%3B&amp;=Alt&amp;_a:7&amp;w:6.25%3B&amp;=&amp;_a:4%3B&amp;=Alt&amp;=Menu&amp;=Ctrl&amp;=←&amp;=↓&amp;=→">Keyboard Layout Editor</a>.</p> <p>I wanted the whole PCB to fit entirely under the keycaps, partly to be slick, and partly because I embraced the challenge. The only exception is the USB-C connector, which sticks out on top. In contrast to that, I cut out enough place under the spacebar for a whole USB-A connector, where the receiver of my wireless mouse should fit. If it works as I planned, I'll be really proud of that! Although I'll admit that if I didn't have this bezel-constraint, I'd prefer to have the receiver on the right side for line of sight.</p> <h2 id="usb-hub"><a href="#usb-hub" aria-hidden="true" class="header-anchor">#</a> USB hub</h2> <p>Designing a keyboard takes a huge amount of time and money, and the schematic of mine was strongly based on the open source Tsuki from the Acheron Project. For these reasons I wanted to have something extra that few others have done, but which is functional and practical for my own use case. This is it.</p> <p>Others have done this, but as far as I can tell, USB hubs isn't yet mainstream in the custom keyboard community. USB is quite complicated, so switching between sources, and combining them isn't as simple as a physical switch would be. As for hubs, there's a few to choose from. I went with the USB2514, partly because it's said to be a better modern one, and partly because I had access to it at Hestore, which is my favorite local electronics shop in Budapest. The only problem I have with it is the packaging, which is the hardest-to-solder part on my keyboard now, but whatever. If I'll have issues with it, I think I will fall back to the FE1.1, because it generally seems easier to use, and it also requires less components around it. Actually, I'm reevaluating my choices as I'm writing this.</p> <p>Since I only plan to use on USB downline on the STM chip, and the other on the wireless mouse receiver, I didn't bother setting up proper power management. My other reason for doing so is cost-effectiveness, and physical space. There's two passive components already, that I pushed on the other side of the PCB, despite my wanting to showcase everything on the bottom side. This compromise still bugs me when I think of it, but I don't think I could have fit power management components. Maybe if I remove the function row, but leave the space as a top-bezel, then I'd have room for these features, and stay in the form-factor of the <a href="https://github.com/coseyfannitutti/discipline">Discipline</a>.</p> <h2 id="back-side-of-the-pcb"><a href="#back-side-of-the-pcb" aria-hidden="true" class="header-anchor">#</a> Back side of the PCB</h2> <p><img src="/img/kb_v2_usb/bottom.svg" alt="PCB bottom"></p> <p>The plan is to have (almost) all of the components on the back side, along with some design features, and to show it all off through an acrylic bottom plate. The huge fish logo is an homage to my hometown in Hungary, Baja, which is famous for the annual fish soup festival. The placement is lucky, as it doesn't cover any other features in the silkscreen.</p> <p>Hofstädter's law says that everything takes longer, than expected, even if one takes into account this law. It's a funny line that will resonate with most engineers. It certainly resonates with me, so I put that on there too.</p> <h2 id="plate"><a href="#plate" aria-hidden="true" class="header-anchor">#</a> Plate</h2> <p><img src="/img/kb_v2_usb/plate_top.svg" alt="Plate"></p> <p>A USB-A connector is too high to fit between the PCB and the plate, so it had to be cut out from the plate. To make it sturdy, I had to disable the horizontal cutout under the space key. I'm curious to see what disadvantages I introduced there.</p></div> <div class="page-edit" data-v-5ebcfcbc><!----> <!----></div> <!----> </div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.36256a3f.js" defer></script><script src="/assets/js/4.0f127261.js" defer></script><script src="/assets/js/6.1357b318.js" defer></script><script src="/assets/js/18.f16249e7.js" defer></script>
  </body>
</html>
